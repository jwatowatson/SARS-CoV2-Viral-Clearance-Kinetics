---
title: "Viral clearance"
author: "James Watson"
date: "20/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, cache.comments = FALSE,
                      echo = F, include = TRUE, 
                      fig.width = 8, fig.height = 8,
                      fig.pos = 'H',dev = 'png', dpi = 300)

library(rstan)
library(matrixStats)
library(mgcv)
library(survival)

# this loads dataset and runs stan models
source('functions.R')
source('run_models.R')
writeLines(sprintf('There are a total of %s infection episodes', length(unique(CT_data$PersonID))))
range(table(CT_data$PersonID))
median(table(CT_data$PersonID))

IDs = as.numeric(names(which(sort(table(CT_data$PersonID))>2)))

D_maxs = c(5,7,14)
D_min = 0
```


## Time to clearance

There are multiple ways to define time to clearance. Time to first 40 is the easiest.
```{r time_to_clear}
CT_data$ID = CT_data$PersonID
CT_data$DeltaCT = 40 - CT_data$CtT1
CT_data_time_clear = time_to_clear(Delta_Ct = CT_data)
```


## Model of viral clearance

```{r}
preds_mod1 = 40-ifelse(colMeans(thetas_mod1$pred_CT)<0,
                       0,colMeans(thetas_mod1$pred_CT))
preds_mod2 = 40-ifelse(colMeans(thetas_mod2$pred_CT)<0,
                       0,colMeans(thetas_mod2$pred_CT))
preds_mod1_NS = 40-colMeans(thetas_mod1$pred_CT)
preds_mod2_NS = 40-colMeans(thetas_mod2$pred_CT)
```



Plot data - those with vaccination status
```{r vaccinated_data, fig.width=10}
cols = RColorBrewer::brewer.pal(n=5, 'Paired')[c(2,5)]
par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3, mfrow=c(1,2))
out_surv=survfit(Surv(time_to_clear, clearance_event) ~ Vaccinated,
                 data = CT_data_time_clear)
plot(out_surv, conf.int=T, col=cols,
     xlab='Days since peak viral load',
     ylab='Proportion still positive')
grid()
legend('bottomleft', col=cols,inset=0.03,
       lwd=3,legend = c('Not vaccinated','Vaccinated'))
out=survdiff(Surv(time_to_clear, clearance_event) ~ Vaccinated,
             data = CT_data_time_clear)
out$chisq

plot(CT_data$time, CT_data$CtT1,
     ylim = c(40, 14), xlab='Days since peak viral load',
     ylab='CT', panel.first=grid(), col=CT_data$Vaccinated+1)
for(id in unique(CT_data$PersonID)){
  ind = CT_data$PersonID==id
  lines(CT_data$time[ind], 
        CT_data$CtT1[ind], col=adjustcolor(cols[CT_data$Vaccinated[ind]+1],.6))
}
CT_data$Day = round(CT_data$time)

xx = aggregate(CtT1~Day+Vaccinated, CT_data, median)
points(xx$Day[xx$Vaccinated==0], xx$CtT1[xx$Vaccinated==0], pch=17, cex=1.5, col='darkblue')
points(xx$Day[xx$Vaccinated==1], xx$CtT1[xx$Vaccinated==1],
       pch=17, cex=1.5,col='red')
legend('topright', title = 'Median daily value',
       legend = c('Not vaccinated', 'Vaccinated'),
       pch=17, col= c('darkblue','red'), inset=0.03)
```


## Spline fits

mgcv 
```{r gam_fits}
AUC_gam = array(dim = c(length(unique(CT_data$PersonID)), length(D_maxs)))
dat=data.frame(time = stan_data1$obs_day, 
               y=stan_data1$delta_CT, 
               ID=as.factor(stan_data1$id))
mod_gam = gam(y ~ s(time) + s(ID, bs='re'), data = dat)
stan_data1$preds_gam = predict(mod_gam)
stan_data1$preds_gam  = ifelse(stan_data1$preds_gam <0,0,stan_data1$preds_gam)
plot(stan_data1$delta_CT, stan_data1$delta_CT-stan_data1$preds_gam)
abline(h=0)

for(id in unique(stan_data1$id)){
  ind = which(stan_data1$id==id)
  xs = seq(0,14, length.out = 100)
  mypreds = predict(mod_gam,
                    data.frame(time=xs,ID=as.factor(id)))
  mypreds = mypreds/mypreds[1]
  ys = ifelse(mypreds<0, 0, mypreds)
  f = approxfun(x = xs, y = ys)
  for(ds in 1:length(D_maxs)){
    AUC_gam[as.numeric(id),ds] = 
      integrate(f = f, lower = D_min,
                upper = D_maxs[ds])$value
  }
}
```

## Estimated parameters


```{r parameter_estimates}
par(las=1, family='serif', cex.lab=1.5, cex.axis=1.5,mfrow=c(4,3))
cols = RColorBrewer::brewer.pal(n=3, 'Dark2')[1:2]

# A0
plot(density(thetas_mod1$intercept), main=expression('A'[0]),
     xlab=expression(paste(Delta,'CT')), ylab='', yaxt='n', xlim = c(15, 20),
     panel.first=grid(),lwd=3, col=cols[1])
lines(density(thetas_mod2$intercept[,2]),lwd=3,lty=2, col=cols[2])

# B0 - model 2 only
plot(density(thetas_mod2$intercept[,1]), main=expression('B'[0]),
     xlab=expression(paste(Delta,'CT')), ylab='', yaxt='n',
     panel.first=grid(),lwd=3,lty=2, xlim = c(5, 15), col=cols[2])

# alpha
plot(density(thetas_mod1$coef), main=expression(alpha), 
     xlab='Change in CT per day',
     ylab='', yaxt='n', xlim = c(0,7),
     panel.first=grid(),lwd=3, col=cols[1])
lines(density(thetas_mod2$coef[,2]),lwd=3,lty=2, col=cols[2])

# beta - model 2 only
plot(density(thetas_mod2$coef[,1]), main=expression(beta), 
     ylab='', yaxt='n', xlab='Change in CT per day',
     panel.first=grid(),lwd=3,lty=2, xlim = c(0, 2), col=cols[2])

# lambda 
plot(density(thetas_mod2$p_err), main=expression(lambda),
     xlab='Probability', ylab='', yaxt='n', xlim = c(0, .15),
     panel.first=grid(),lwd=3, lty=2, col=cols[2])
lines(density(thetas_mod1$p_err), lwd=3, col=cols[1])

# sigma CT
plot(density(thetas_mod2$sigmaCT), main=expression(sigma[CT]),
     xlab='CT', ylab='', yaxt='n', xlim = c(2, 4),
     panel.first=grid(),lwd=3, lty=2, col=cols[2])
lines(density(thetas_mod1$sigmaCT),lwd=3, col=cols[1])

# error model: mu
plot(density(thetas_mod1$mu_noise), main=expression(mu[noise]),
     xlab='CT', ylab='', yaxt='n', xlim = c(0, 5),
     panel.first=grid(),lwd=3, col=cols[1])
lines(density(thetas_mod2$mu_noise), lwd=3, lty=2, col=cols[2])

# error model: sigma
plot(density(thetas_mod1$sigma_noise), main=expression(sigma[noise]),
     xlab='CT', ylab='', yaxt='n', xlim = c(0, 3),
     panel.first=grid(),lwd=3, col=cols[1])
lines(density(thetas_mod2$sigma_noise), lwd=3, lty=2, col=cols[2])


plot(density(thetas_mod1$sigmasq_u[,1]), main=expression(sigma[u1]),
     xlab='CT', ylab='', yaxt='n', xlim = c(1, 5),
     panel.first=grid(),lwd=3, col=cols[1])
lines(density(thetas_mod2$sigmasq_u[,1]), lwd=3, lty=2, col=cols[2])

plot(density(thetas_mod1$sigmasq_u[,2]), main=expression(sigma[u2]),
     xlab='CT', ylab='', yaxt='n', xlim = c(0, 1),
     panel.first=grid(),lwd=3, col=cols[1])
lines(density(thetas_mod2$sigmasq_u[,2]),lwd=3, lty=2, col=cols[2])

plot(density(thetas_mod2$sigmasq_u[,3]), main=expression(sigma[u3]),
     xlab='CT', ylab='', yaxt='n', xlim = c(0, 7),
     panel.first=grid(),lwd=3,lty=2, col=cols[2])

plot(density(thetas_mod2$sigmasq_u[,4]), main=expression(sigma[u4]),
     xlab='CT', ylab='', yaxt='n', xlim = c(0, 1),
     panel.first=grid(),lwd=3,lty=2, col=cols[2])
```





## Figure 1 - model fits

```{r Fig1}
mycols = RColorBrewer::brewer.pal(n=4, 'Dark2')
par(las=1, family='serif', cex.lab=1.5, cex.axis=1.5)
layout(mat = matrix(c(1,1,1,2,3,4),nrow = 2,byrow = T))
plot(CT_data$time, CT_data$CtT1,
     ylim = c(40, 14), xlab='Days since peak viral load',
     ylab='CT', panel.first=grid())
mtext(text = 'A',side = 3,adj = 0,line = 1.5,cex = 1.3)
for(id in unique(CT_data$PersonID)){
  ind = CT_data$PersonID==id
  lines(CT_data$time[ind], 
        CT_data$CtT1[ind], col=adjustcolor('grey',.4))
}
CT_data$Day = round(CT_data$time)
xs = seq(0,14,length.out = 100)
preds1 = 40 - (mean(thetas_mod1$intercept) - mean(thetas_mod1$coef)*xs)
lines(xs, preds1, lwd=4, col=mycols[1])

preds2 = 40 - 
  apply(cbind(mean(thetas_mod2$intercept[,1])-
                mean(thetas_mod2$coef[,1])*xs,
              mean(thetas_mod2$intercept[,2])-
                mean(thetas_mod2$coef[,2])*xs),1,logSumExp)
lines(xs, preds2, lwd=4, col=mycols[2],lty=2)

preds3=predict(mod_gam, data.frame(time = xs, ID=-1), re.effect=NA)
lines(xs, 40-preds3, lwd=4, col=mycols[3],lty=3)

xx = aggregate(CtT1~Day, CT_data, median)
points(xx$Day, xx$CtT1, pch=17, cex=2, col=mycols[4])

legend('topright',lwd=c(3,3,3,NA), 
       col=mycols,lty=c(1:3,NA),
       pch=c(NA,NA,NA,17), inset = 0.03, cex=1.3,
       legend = c('Exponential','Bi-exponential','Spline','Observed median'))

plot(40-stan_data1$delta_CT, 
     40-stan_data1$delta_CT-preds_mod1,
     xlab='Observed CT',ylab='Residual CT',
     main='',ylim=c(-10,10),
     panel.first=grid())
mtext(text = 'B - exponential',side = 3,adj = 0,line = 1.5,cex = 1.3)

abline(h=0, lwd=3,lty=2)
abline(lm(y~x, data.frame(y=40-stan_data1$delta_CT-preds_mod1,x= 40-stan_data1$delta_CT)),col='blue',lwd=2)


plot(40-stan_data1$delta_CT, 
     40-stan_data1$delta_CT-preds_mod2,
     xlab='Observed CT',ylab='Residual CT',
     main='',ylim=c(-10,10),
     panel.first=grid())
mtext(text = 'C - bi-exponential',side = 3,adj = 0,line = 1.5,cex = 1.3)

abline(h=0, lwd=3,lty=2)
abline(lm(y~x, data.frame(y=40-stan_data1$delta_CT-preds_mod2,x= 40-stan_data1$delta_CT)),col='blue',lwd=2)


plot(40-stan_data1$delta_CT, 
     -stan_data1$delta_CT+stan_data1$preds_gam,
     xlab='Observed CT',ylab='Residual CT',
     main='',ylim=c(-10,10),
     panel.first=grid())
mtext(text = 'D - spline regression',side = 3,adj = 0,line = 1.5,cex = 1.3)

abline(h=0, lwd=3,lty=2)
abline(lm(y~x, data.frame(y= -stan_data1$delta_CT+stan_data1$preds_gam,x= 40-stan_data1$delta_CT)),col='blue',lwd=2)
```


Individual fits data 1 - we pick the individuals with the most data
```{r data1_individual_fits}
IDs_dense = as.numeric(names(which(sort(table(stan_data1$id))>=10)))
par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
xs = seq(0,14, length.out = 100)
par(mfrow=c(4,4), mar=c(3,3,1,1),las=1)
for(id in IDs_dense){
  ind = which(stan_data1$id==id)
  plot(stan_data1$obs_day[ind], 
       40-stan_data1$delta_CT[ind],
       ylim=c(40,15),
       xlab='', ylab='', main='', xaxt='n',yaxt='n',
       xlim=c(0,Max_Day), panel.first=grid())
  
  # Model 1
  intercept = median(thetas_mod1$intercept + thetas_mod1$theta_rand[,id,1])
  alpha = median(thetas_mod1$coef * exp(thetas_mod1$theta_rand[,id,2]))
  lines(xs, 40-(intercept - alpha*xs), lty=1,lwd=2, col=mycols[1]) 
  
  # Model 2
  intercept1 = median(thetas_mod2$intercept[,2] + thetas_mod2$theta_rand[,id,1])
  intercept2 = median(thetas_mod2$intercept[,1] + thetas_mod2$theta_rand[,id,3])
  alpha = median(thetas_mod2$coef[,2]*exp(thetas_mod2$theta_rand[,id,2]))
  beta = median(thetas_mod2$coef[,1]*exp(thetas_mod2$theta_rand[,id,4]))
  ys = cbind(intercept1 - alpha*xs, intercept2 - beta*xs)
  preds = apply(ys, 1, logSumExp)
  lines(xs, 40-preds,lwd=2,lty=2, col=mycols[2])
  
  # Spline model
  mypreds = predict(mod_gam,
                    data.frame(time=xs,ID=as.factor(id)))
  lines(xs, 40-mypreds,lwd=2,lty=3, col=mycols[3])
  
  points(stan_data1$obs_day[ind],
         40-stan_data1$delta_CT[ind],
         col=1, pch=16)
  axis(1, at = c(0,7,14))
  axis(2, at = c(12,20,30,40))
  
}
```




## Compute area under the curve

```{r auc, echo=F}
AUC_mod1 = AUC_mod2 = array(dim = c(stan_data1$n_id, length(D_maxs)))
FC_mod1 = FC_mod2 = array(dim = c(stan_data1$n_id, length(D_maxs)))
Nsim = 300

for(ds in 1:length(D_maxs)){
  writeLines(sprintf('Doing D max = %s ....', D_maxs[ds]))
  xs = seq(0,D_maxs[ds], length.out = 100)
  for(i in 1:stan_data1$n_id){
    # Model 0
    fcs = aucs = array(dim = Nsim); my_ix=1
    for(ss in sample(1:length(thetas_mod1$p_err), Nsim, replace = F)){
      intercept = thetas_mod1$intercept[ss] + thetas_mod1$theta_rand[ss,i,1]
      alpha = thetas_mod1$coef[ss]*exp(thetas_mod1$theta_rand[ss,i,2])
      fcs[my_ix] = -alpha*D_maxs[ds]
      preds = 1 - alpha*xs/intercept # normalise by intercept
      f = approxfun(x = xs, y = ifelse(preds<0,0,preds))
      aucs[my_ix] = integrate(f = f, lower = D_min, upper = D_maxs[ds])$value
      my_ix=my_ix+1
    }
    AUC_mod1[i,ds] = median(aucs)
    FC_mod1[i,ds] = median(fcs)
    
    # Model 1
    fcs = aucs = array(dim = Nsim); my_ix=1
    for(ss in sample(1:length(thetas_mod2$p_err), Nsim, replace = F)){
      
      intercept1 = thetas_mod2$intercept[ss,2] + thetas_mod2$theta_rand[ss,i,1]
      intercept2 = thetas_mod2$intercept[ss,1] + thetas_mod2$theta_rand[ss,i,3]
      alpha = thetas_mod2$coef[ss,2]*exp(thetas_mod2$theta_rand[ss,i,2])
      beta = thetas_mod2$coef[ss,1]*exp(thetas_mod2$theta_rand[ss,i,4])
      fcs[my_ix] = 
        logSumExp(c(intercept1, intercept2))-
        logSumExp(c(intercept1-alpha*D_maxs[ds],
                    intercept2-beta*D_maxs[ds]))
      ys = cbind(intercept1 - alpha*xs, intercept2 - beta*xs)
      preds = apply(ys, 1, logSumExp)
      preds_mod1 = preds/preds[1]
      f = approxfun(x = xs, y = ifelse(preds_mod1<0,0,preds_mod1))
      aucs[my_ix] = integrate(f = f, lower = D_min, D_maxs[ds])$value
      my_ix=my_ix+1
    }
    AUC_mod2[i,ds] = median(aucs)
    FC_mod2[i,ds] = median(fcs)
  }
}
```


Reduction in AUCs
```{r AUC_comparison}
vacc_ind = unique(stan_data1$id[which(stan_data1$vacc==1)])
not_vacc_ind = unique(stan_data1$id[which(stan_data1$vacc==0)])

par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
mycols = RColorBrewer::brewer.pal(n=3, 'Dark2')
plot(NA, NA, xlim = c(4, 15), ylim = c(-35,5),xaxt='n',
     xlab = 'Days follow-up for AUC', panel.first=grid(),
     ylab = 'Reduction in AUC: vaccinated versus not vaccinated')
axis(1, at = D_maxs)
abline(h=0, lty=2)
for(ds in 1:length(D_maxs)){
  out=(t.test(AUC_mod1[not_vacc_ind,ds], AUC_mod1[vacc_ind,ds]))
  points(D_maxs[ds]-.2, diff(out$estimate)/out$estimate[1]*100,pch=1,col=mycols[1],cex=1.5)
  lines(c(D_maxs[ds],D_maxs[ds])-.2,
        -out$conf.int/out$estimate[1]*100,col=mycols[1],lwd=3)
  writeLines(sprintf('Model 1: Wilcoxon test for AUC up to day %s: p= %s',D_maxs[ds], wilcox.test(AUC_mod1[not_vacc_ind,ds],AUC_mod1[vacc_ind,ds])$p.value))
  
  out=(t.test(AUC_mod2[not_vacc_ind,ds], AUC_mod2[vacc_ind,ds]))
  points(D_maxs[ds], diff(out$estimate)/out$estimate[1]*100,pch=2,col=mycols[2],cex=1.5)
  lines(c(D_maxs[ds],D_maxs[ds]),
        -out$conf.int/out$estimate[1]*100,col=mycols[2],lwd=3)
  writeLines(sprintf('Model 2: Wilcoxon test for AUC up to day %s: p= %s',
                     D_maxs[ds], 
                     wilcox.test(AUC_mod2[not_vacc_ind,ds],
                                 AUC_mod2[vacc_ind,ds])$p.value))
  
  out=(t.test(AUC_gam[not_vacc_ind,ds], AUC_gam[vacc_ind,ds]))
  points(D_maxs[ds]+.2, diff(out$estimate)/out$estimate[1]*100,pch=3,col=mycols[3],cex=1.5)
  lines(c(D_maxs[ds]+.2,D_maxs[ds]+.2),
        -out$conf.int/out$estimate[1]*100,col=mycols[3],lwd=3)
}
legend('bottomleft', inset=0.03, 
       legend = c('Exponential','Bi-exponential',
                  'Spline'),
       pch = 1:3, lwd=2, col=mycols)
```



```{r}
par(mfrow = c(2,2))
hist(colMeans(thetas_mod1$theta_rand[,not_vacc_ind,2]), breaks=seq(-1.5,1.5,by=.25))
hist(colMeans(thetas_mod1$theta_rand[,vacc_ind,2]), breaks=seq(-1.5,1.5,by=.25))

t.test(colMeans(thetas_mod1$theta_rand[,not_vacc_ind,2]),
       colMeans(thetas_mod1$theta_rand[,vacc_ind,2]))

```


Fold change
```{r}
par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
mycols = RColorBrewer::brewer.pal(n=4, 'Dark2')
plot(NA, NA, xlim = range(D_maxs), ylim = c(0,10),xaxt='n',
     xlab = 'Days follow-up', panel.first=grid(),
     ylab = 'Fold change: vaccinated versus not vaccinated')
axis(1, at = D_maxs)
abline(h=0, lty=2)
for(ds in 1:length(D_maxs)){
  out=t.test(FC_mod1[not_vacc_ind,ds], FC_mod1[vacc_ind,ds])
  points(D_maxs[ds]-.2, diff(out$estimate),pch=1,col=mycols[1])
  lines(c(D_maxs[ds],D_maxs[ds])-.2,-out$conf.int,col=mycols[1])
  writeLines(sprintf('Model 1: Wilcoxon test for AUC up to day %s: p= %s',D_maxs[ds], wilcox.test(FC_mod1[not_vacc_ind,ds],FC_mod1[vacc_ind,ds])$p.value))
  
  out=t.test(FC_mod2[not_vacc_ind,ds], FC_mod2[vacc_ind,ds])
  points(D_maxs[ds]-.05, diff(out$estimate),pch=2,col=mycols[2])
  lines(c(D_maxs[ds],D_maxs[ds])-.05,-out$conf.int,col=mycols[2])
  writeLines(sprintf('Model 2: Wilcoxon test for AUC up to day %s: p= %s',D_maxs[ds], wilcox.test(FC_mod2[not_vacc_ind,ds],FC_mod2[vacc_ind,ds])$p.value))
}
legend('topleft', inset=0.03, 
       legend = c('Exponential','Bi-exponential'),
       pch = 1:2, lwd=2, col=mycols[1:2])
```


## Variants and vaccines

effect of variant
```{r variant_effect, fig.width=8, fig.height=6}
par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
par(mfrow=c(1,2),las=1)
ind_unique = !duplicated(stan_data1$id)
table(stan_data1$variant[ind_unique])

boxplot(apply(thetas_mod1$theta_rand[,,2],2,mean) ~ stan_data1$variant[ind_unique],
        xlab='',las=2,
        ylab = 'Slope difference',varwidth=T)


boxplot(apply(thetas_mod2$theta_rand[,,2],2,mean) ~ stan_data1$variant[ind_unique],
        xlab='',las=2,
        ylab = 'Slope difference',varwidth=T)
```


effect of vaccine
```{r vaccine_effect, fig.width=8, fig.height=6}
par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
par(mfrow=c(1,2),las=1)
table(stan_data1$vacc[ind_unique])

boxplot(apply(thetas_mod1$theta_rand[,,2],2,mean) ~ stan_data1$vacc[ind_unique],xlab='Vaccinated',
        ylab = 'Slope difference',varwidth=T)

boxplot(apply(thetas_mod2$theta_rand[,,2],2,mean) ~ stan_data1$vacc[ind_unique],
        xlab='Vaccinated',ylab = 'Slope difference',varwidth=T)

plot(stan_data1$obs_day, 40-stan_data1$delta_CT,
     xlim=c(0,7), ylim=c(40,15), type='n',main='Exponential',
     xlab='Days since peak viral load',ylab='CT',
     panel.first=grid())
for(i in 1:stan_data1$n_id){
  # Model 0
  intercept = mean(thetas_mod1$intercept + thetas_mod1$theta_rand[,i,1])
  alpha = mean(thetas_mod1$coef + thetas_mod1$theta_rand[,i,2])
  preds = 1 + alpha*xs/intercept
  vacc = stan_data1$vacc[ind_unique][i]
  if(!is.na(vacc)){
    if(vacc==0) {mycol = 'grey';mylty=2} else {mycol = 'red';mylty=2}
    lines(xs, 40 - preds*intercept, col = mycol,lty=mylty,lwd=2)
  }
}
legend('topright',col=c('grey','red'),inset = 0.03,lty=c(2,1),
       legend = c('Not vaccinated','Vaccinated'),lwd=2)

plot(stan_data1$obs_day, 40-stan_data1$delta_CT,
     xlim=c(0,7), ylim=c(40,15), type='n',main='Bi-exponential',
     xlab='Days since peak viral load',ylab='CT',
     panel.first=grid())
for(i in 1:stan_data1$n_id){
  # Model 1
  intercept = mean(thetas_mod2$intercept + thetas_mod2$theta_rand[,i,1])
  intercept = mean(thetas_mod2$intercept + thetas_mod2$theta_rand[,i,3])
  alpha = mean(thetas_mod2$coef[,1] + thetas_mod2$theta_rand[,i,2])
  beta = mean(thetas_mod2$coef[,2] + thetas_mod2$theta_rand[,i,4])
  ys = cbind(intercept + alpha*xs, intercept + beta*xs)
  preds = apply(ys, 1, logSumExp)
  vacc = stan_data1$vacc[ind_unique][i]
  if(!is.na(vacc)){
    
    if(vacc==0) {mycol = 'grey';mylty=2} else {mycol = 'red';mylty=1}
    lines(xs, 40 - preds, col = mycol,lty=mylty,lwd=2)
  }
}

```



Sensitivity analysis - AUC day 7 models
```{r auc_day7, echo=F}
# source('run_models_day7.R')
# AUC_mod1_D7 = AUC_mod2_D7 = array(dim = c(stan_data1$n_id, length(D_maxs)))
# Nsim = 100
# 
# for(ds in 1:length(D_maxs)){
#   writeLines(sprintf('Doing D max = %s ....', D_maxs[ds]))
#   xs = seq(0,D_maxs[ds], length.out = 100)
#   for(i in 1:stan_data1$n_id){
#     # Model 1
#     aucs = array(dim = Nsim); my_ix=1
#     for(ss in sample(1:length(thetas_mod1_day7$intercept), Nsim, replace = F)){
#       intercept = thetas_mod1_day7$intercept[ss] + thetas_mod1_day7$theta_rand[ss,i,1]
#       alpha = thetas_mod1_day7$coef[ss] + thetas_mod1_day7$theta_rand[ss,i,2]
#       preds = 1 + alpha*xs/intercept # normalise by intercept
#       f = approxfun(x = xs, y = ifelse(preds<0,0,preds))
#       aucs[my_ix] = integrate(f = f, lower = D_min, upper = D_maxs[ds])$value
#       my_ix=my_ix+1
#     }
#     AUC_mod1_D7[i,ds] = mean(aucs)
#     
#     # Model 2
#     aucs = array(dim = Nsim); my_ix=1
#     for(ss in sample(1:length(thetas_mod2_day7$intercept), Nsim, replace = F)){
#       
#       intercept = thetas_mod2_day7$intercept[ss] + thetas_mod2_day7$theta_rand[ss,i,1]
#       intercept = thetas_mod2_day7$intercept[ss] + thetas_mod2_day7$theta_rand[ss,i,3]
#       alpha = thetas_mod2_day7$coef[ss,1] + thetas_mod2_day7$theta_rand[ss,i,2]
#       beta = thetas_mod2_day7$coef[ss,2] + thetas_mod2_day7$theta_rand[ss,i,4]
#       
#       ys = cbind(intercept + alpha*xs, intercept + beta*xs)
#       preds = apply(ys, 1, logSumExp)
#       preds_mod1 = preds/preds[1]
#       f = approxfun(x = xs, y = ifelse(preds_mod1<0,0,preds_mod1))
#       aucs[my_ix] = integrate(f = f, lower = D_min, D_maxs[ds])$value
#       my_ix=my_ix+1
#     }
#     AUC_mod2_D7[i,ds] = mean(aucs)
#   }
# }
```

AUC reduction - only using data up to day 7

```{r}
# vacc_ind = unique(stan_data1$id[which(stan_data1$vacc==1)])
# not_vacc_ind = unique(stan_data1$id[which(stan_data1$vacc==0)])
# 
# par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
# mycols = RColorBrewer::brewer.pal(n=4, 'Dark2')
# plot(NA, NA, xlim = range(D_maxs), ylim = c(-30,5),xaxt='n',
#      xlab = 'Days follow-up for AUC', panel.first=grid(),
#      ylab = 'Reduction in AUC: vaccinated versus not vaccinated')
# axis(1, at = D_maxs)
# abline(h=0, lty=2)
# for(ds in 1:length(D_maxs)){
#   out=(t.test(AUC_mod1_D7[not_vacc_ind,ds], AUC_mod1_D7[vacc_ind,ds]))
#   points(D_maxs[ds]-.2, diff(out$estimate)/out$estimate[1]*100,pch=1,col=mycols[1])
#   lines(c(D_maxs[ds],D_maxs[ds])-.2,
#         -out$conf.int/out$estimate[1]*100,col=mycols[1])
#   writeLines(sprintf('Model 1: Wilcoxon test for AUC up to day %s: p= %s',D_maxs[ds], wilcox.test(AUC_mod1_D7[not_vacc_ind,ds],AUC_mod1_D7[vacc_ind,ds])$p.value))
#   
#   out=(t.test(AUC_mod2_D7[not_vacc_ind,ds], AUC_mod2_D7[vacc_ind,ds]))
#   points(D_maxs[ds]-.05, diff(out$estimate)/out$estimate[1]*100,pch=2,col=mycols[2])
#   lines(c(D_maxs[ds],D_maxs[ds])-.05,
#         -out$conf.int/out$estimate[1]*100,col=mycols[2])
#   writeLines(sprintf('Model 2: Wilcoxon test for AUC up to day %s: p= %s',D_maxs[ds], wilcox.test(AUC_mod2_D7[not_vacc_ind,ds],AUC_mod2_D7[vacc_ind,ds])$p.value))
#   
# }
# legend('bottomleft', inset=0.03, 
#        legend = c('Exponential','Bi-exponential',
#                   'Mixture','Spline'),
#        pch = 1:4, lwd=2, col=mycols)
```



## Sample size estimation

```{r power_calculations, fig.height=7, fig.width=10}
source('functions.R')
load('Rout/power_matrix.RData')
load('Rout/power_matrix_TTC.RData')
load('Rout/mod_2.RData')
thetas_mod2 = extract(out_mod2)
my_effects = unique(res_power$effect)

par(mfrow=c(1,2), las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
set.seed(75873426)
Delta_Ct0 =
  sim_individuals(thetas = thetas_mod2,
                  N = 1000,
                  t_design = seq(0,7, length.out = 15),
                  Trt_effect = rep(1, 10^3))
Delta_Ct1 =
  sim_individuals(thetas = thetas_mod2,
                  N = 1000,
                  t_design = seq(0,7, length.out = 15),
                  Trt_effect = rep(my_effects[1], 10^3))
Delta_Ct2 =
  sim_individuals(thetas = thetas_mod2,
                  N = 1000,
                  t_design = seq(0,7, length.out = 15),
                  Trt_effect = rep(my_effects[2], 10^3))
plot(Delta_Ct0$time, 40-Delta_Ct0$DeltaCT, ylim = c(40, 20),type='n',
     xlab='Days', ylab='CT',panel.first=grid())
lines(aggregate(40-DeltaCT ~ time, Delta_Ct0, median),lwd=2)
lines(aggregate(40-DeltaCT ~ time, Delta_Ct1, median),lwd=2,lty=2)
lines(aggregate(40-DeltaCT ~ time, Delta_Ct2, median),lwd=2,lty=3)
legend('topright', lty=1:3, lwd=2, legend = c('0','30%','50%'),
       title = expression(paste(beta, ' and ', alpha, ' increase (%)')),
       inset = 0.03)

xx = aggregate(power ~ effect + N + t_design, 
               data = res_power, FUN = mean)
plot(xx$N, xx$power, pch = as.numeric(as.factor(xx$effect)),
     xlab='Number of patients per arm', ylab='Power',
     panel.first=grid(), ylim=c(0,1))
abline(h=0.8, lty=2)
lines(xx$N[xx$effect==my_effects[1]],
      xx$power[xx$effect==my_effects[1]],lwd=2)
lines(xx$N[xx$effect==my_effects[2]],
      xx$power[xx$effect==my_effects[2]],lwd=2)

xx = aggregate(power ~ effect + N + t_design, 
               data = res_power_TTC,FUN =  mean)
points(xx$N, xx$power, pch = as.numeric(as.factor(xx$effect)),col='darkblue')
lines(xx$N[xx$effect==my_effects[1]], xx$power[xx$effect==my_effects[1]],lty=2,lwd=2,col='darkblue')
lines(xx$N[xx$effect==my_effects[2]], xx$power[xx$effect==my_effects[2]],lty=3,lwd=2,col='darkblue')
```


